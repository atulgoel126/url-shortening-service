<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - frwrd.pro</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Bootstrap for layout only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="/css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heatmap.js@2.0.5/build/heatmap.min.js"></script>
    <style>
        .analytics-card {
            border: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .heatmap-container {
            position: relative;
            min-height: 400px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .traffic-source-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .country-badge {
            display: inline-block;
            padding: 5px 10px;
            background: #e3f2fd;
            border-radius: 15px;
            margin: 2px;
            font-size: 0.85rem;
        }
    </style>
    <style>
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg"></div>
    
    <!-- Navigation -->
    <div th:replace="~{fragments/navbar :: navbar('analytics')}">
    </div>

    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <h1>Analytics Dashboard</h1>
                <div th:if="${isLinkSpecific}" class="alert alert-info mt-2 mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-link-45deg"></i> <strong>Viewing analytics for link:</strong> 
                            <code th:text="${@appConfig.baseUrl + '/link/' + selectedLink.shortCode}"></code>
                            <br>
                            <small class="text-muted">Destination: <span th:text="${selectedLink.longUrl}"></span></small>
                        </div>
                        <a href="/analytics" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrow-left"></i> View All Links
                        </a>
                    </div>
                </div>
                <p class="text-muted" th:unless="${isLinkSpecific}">Comprehensive insights into your link performance</p>
                <p class="text-muted" th:if="${isLinkSpecific}">Detailed analytics for your selected link</p>
            </div>
        </div>

        <!-- Date Range Filter -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <form method="get" action="/analytics">
                            <input th:if="${isLinkSpecific}" type="hidden" name="linkId" th:value="${selectedLink.shortCode}">
                            <div class="row">
                                <div class="col">
                                    <label>Start Date</label>
                                    <input type="date" class="form-control" name="startDate" 
                                           th:value="${#temporals.format(startDate, 'yyyy-MM-dd')}">
                                </div>
                                <div class="col">
                                    <label>End Date</label>
                                    <input type="date" class="form-control" name="endDate" 
                                           th:value="${#temporals.format(endDate, 'yyyy-MM-dd')}">
                                </div>
                                <div class="col-auto align-self-end">
                                    <button type="submit" class="btn btn-primary">Apply</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overview Metrics -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="metric-card">
                    <div class="metric-value" th:text="${dashboard.overview.totalViews}">0</div>
                    <div class="metric-label">Total Views</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="metric-value" th:text="${dashboard.overview.completedViews}">0</div>
                    <div class="metric-label">Completed Views</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="metric-value" th:text="${#numbers.formatDecimal(dashboard.overview.completionRate, 1, 1) + '%'}">0%</div>
                    <div class="metric-label">Completion Rate</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="metric-value" th:text="${dashboard.overview.uniqueVisitors}">0</div>
                    <div class="metric-label">Unique Visitors</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <div class="metric-value" th:text="${#numbers.formatDecimal(dashboard.overview.averageTimeToSkip, 1, 1) + 's'}">0s</div>
                    <div class="metric-label">Avg Time to Skip</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                    <div class="metric-value" th:text="${dashboard.overview.totalLinks}">0</div>
                    <div class="metric-label">Total Links</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Traffic Sources -->
            <div class="col-md-4">
                <div class="card analytics-card">
                    <div class="card-header">
                        <h5>Traffic Sources</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="trafficSourceChart"></canvas>
                        <div class="mt-3">
                            <div th:each="source : ${dashboard.trafficSources}" class="traffic-source-item">
                                <span th:text="${source.source}">Direct</span>
                                <span>
                                    <strong th:text="${source.visits}">0</strong>
                                    <small class="text-muted" th:text="${'(' + #numbers.formatDecimal(source.percentage, 1, 1) + '%)'}"></small>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Geographic Distribution -->
            <div class="col-md-4">
                <div class="card analytics-card">
                    <div class="card-header">
                        <h5>Geographic Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="geoChart"></canvas>
                        <div class="mt-3">
                            <div th:each="geo : ${dashboard.geographicData}">
                                <div class="mb-2">
                                    <strong th:text="${geo.country}">Country</strong>
                                    <span class="float-end" th:text="${geo.views + ' views'}">0 views</span>
                                </div>
                                <div class="progress mb-3" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" 
                                         th:style="${'width: ' + geo.percentage + '%'}"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Device Analytics -->
            <div class="col-md-4">
                <div class="card analytics-card">
                    <div class="card-header">
                        <h5>Device Analytics</h5>
                    </div>
                    <div class="card-body">
                        <h6>Device Types</h6>
                        <canvas id="deviceChart"></canvas>
                        
                        <h6 class="mt-4">Browsers</h6>
                        <div th:each="entry : ${dashboard.deviceAnalytics.browsers}">
                            <div class="d-flex justify-content-between mb-2">
                                <span th:text="${entry.key}">Browser</span>
                                <span th:text="${#numbers.formatDecimal(entry.value, 1, 1) + '%'}">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Analytics -->
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="card analytics-card">
                    <div class="card-header">
                        <h5>Traffic Over Time</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="timeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Performing Links -->
            <div class="col-md-4">
                <div class="card analytics-card">
                    <div class="card-header">
                        <h5>Top Performing Links</h5>
                    </div>
                    <div class="card-body">
                        <div th:each="link : ${dashboard.topPerformingLinks}" class="mb-3">
                            <div class="d-flex justify-content-between">
                                <div style="max-width: 70%;">
                                    <small class="text-muted" th:text="${link.shortCode}">code</small>
                                    <div class="text-truncate" th:text="${link.longUrl}">URL</div>
                                </div>
                                <div class="text-end">
                                    <div><strong th:text="${link.views}">0</strong> views</div>
                                    <div class="text-success">â‚¹<span th:text="${#numbers.formatDecimal(link.earnings, 1, 2)}">0.00</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Heatmap Section - Temporarily Commented Out -->
        <!--
        <div class="row mt-4">
            <div class="col-12">
                <div class="card analytics-card">
                    <div class="card-header">
                        <h5>Click Heatmap</h5>
                        <small class="text-muted">Visual representation of where users click most</small>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select id="heatmapLinkSelect" class="form-select">
                                    <option value="">Select a link to view heatmap</option>
                                    <option th:each="link : ${userLinks}" 
                                            th:value="${link.shortCode}" 
                                            th:selected="${selectedLink != null && selectedLink.shortCode == link.shortCode}"
                                            th:text="${link.shortCode + ' - ' + link.longUrl}">Link</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary" onclick="loadHeatmap()">Load Heatmap</button>
                            </div>
                        </div>
                        <div id="heatmapContainer" class="heatmap-container">
                            <div class="text-center p-5 text-muted">
                                Select a link above to view its click heatmap
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        -->
    </div>

    <script th:inline="javascript">
        // Initialize charts with data from backend
        const dashboard = /*[[${dashboard}]]*/ {};
        
        // Traffic Source Pie Chart
        const trafficCtx = document.getElementById('trafficSourceChart').getContext('2d');
        new Chart(trafficCtx, {
            type: 'doughnut',
            data: {
                labels: dashboard.trafficSources.map(s => s.source),
                datasets: [{
                    data: dashboard.trafficSources.map(s => s.visits),
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c',
                        '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Device Type Chart
        const deviceCtx = document.getElementById('deviceChart').getContext('2d');
        const deviceData = dashboard.deviceAnalytics.deviceTypes;
        new Chart(deviceCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(deviceData),
                datasets: [{
                    data: Object.values(deviceData),
                    backgroundColor: ['#667eea', '#f093fb', '#4facfe']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Time Chart
        const timeCtx = document.getElementById('timeChart').getContext('2d');
        const timeData = dashboard.timeAnalytics.weeklyTrend;
        new Chart(timeCtx, {
            type: 'line',
            data: {
                labels: Object.keys(timeData),
                datasets: [{
                    label: 'Views',
                    data: Object.values(timeData),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Geographic Chart
        const geoCtx = document.getElementById('geoChart').getContext('2d');
        const geoData = dashboard.geographicData.slice(0, 5);
        new Chart(geoCtx, {
            type: 'bar',
            data: {
                labels: geoData.map(g => g.country),
                datasets: [{
                    label: 'Views',
                    data: geoData.map(g => g.views),
                    backgroundColor: '#667eea'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Heatmap functionality
        function loadHeatmap() {
            const select = document.getElementById('heatmapLinkSelect');
            const shortCode = select.value;
            
            if (!shortCode) {
                alert('Please select a link');
                return;
            }
            
            fetch(`/api/analytics/heatmap/${shortCode}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    renderHeatmap(data);
                })
                .catch(error => {
                    console.error('Error loading heatmap:', error);
                    // Show a message instead of alert
                    const container = document.getElementById('heatmapContainer');
                    container.innerHTML = `
                        <div class="text-center p-5">
                            <i class="bi bi-info-circle display-4 text-muted"></i>
                            <p class="mt-3 text-muted">No click data available for this link yet.</p>
                            <small class="text-muted">Click data will appear here once users interact with your ad page.</small>
                        </div>
                    `;
                });
        }
        
        function renderHeatmap(clickData) {
            const container = document.getElementById('heatmapContainer');
            
            if (!clickData || clickData.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-5">
                        <i class="bi bi-mouse display-4 text-muted"></i>
                        <p class="mt-3 text-muted">No click data recorded yet for this link.</p>
                        <small class="text-muted">Heatmap will be generated once users start clicking on your ad page.</small>
                    </div>
                `;
                return;
            }
            
            // Clear container and set up for heatmap
            container.style.position = 'relative';
            container.innerHTML = '';
            
            // Create a canvas element
            const canvas = document.createElement('div');
            canvas.style.width = '100%';
            canvas.style.height = '400px';
            canvas.style.position = 'relative';
            container.appendChild(canvas);
            
            // Create heatmap instance
            const heatmapInstance = h337.create({
                container: canvas,
                radius: 30,
                maxOpacity: 0.7,
                minOpacity: 0.1,
                blur: 0.75,
                gradient: {
                    0.0: 'blue',
                    0.25: 'cyan',
                    0.5: 'lime',
                    0.75: 'yellow',
                    1.0: 'red'
                }
            });
            
            // Transform click data for heatmap
            const containerWidth = canvas.offsetWidth || 800;
            const containerHeight = 400;
            
            const points = clickData.map(click => {
                // Scale coordinates to fit the display container
                let x = click.xCoordinate || 0;
                let y = click.yCoordinate || 0;
                
                // If coordinates seem to be from a larger viewport, scale them down
                if (click.viewportWidth && click.viewportWidth > containerWidth) {
                    x = (x / click.viewportWidth) * containerWidth;
                }
                if (click.viewportHeight && click.viewportHeight > containerHeight) {
                    y = (y / click.viewportHeight) * containerHeight;
                }
                
                // Ensure coordinates are within bounds
                x = Math.max(0, Math.min(x, containerWidth));
                y = Math.max(0, Math.min(y, containerHeight));
                
                return {
                    x: Math.round(x),
                    y: Math.round(y),
                    value: 1
                };
            });
            
            console.log('Rendering heatmap with points:', points);
            
            heatmapInstance.setData({
                max: Math.max(5, points.length / 2),
                data: points
            });
            
            // Add info about the heatmap
            const info = document.createElement('div');
            info.className = 'text-center mt-3';
            info.innerHTML = `<small class="text-muted">${clickData.length} real clicks recorded (no demo data)</small>`;
            container.appendChild(info);
        }
        
        // Auto-load heatmap when viewing specific link analytics
        document.addEventListener('DOMContentLoaded', function() {
            const isLinkSpecific = /*[[${isLinkSpecific}]]*/ false;
            if (isLinkSpecific) {
                // Auto-load the heatmap for the selected link
                setTimeout(() => {
                    loadHeatmap();
                }, 500);
            }
        });
    </script>
</body>
</html>